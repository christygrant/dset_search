<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <meta http-equiv="X-UA-Compatible" content="IE=edge">
 <meta name="viewport" content="width=device-width, initial-scale=1">

 <title>DataCite NCAR query</title>
  
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
 
 <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script> 
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
            
 <!-- NCAR Theme -->
 <link href="assets/css/fonts.css" rel="stylesheet" />
 <link href="assets/css/custom.css" type="text/css" media="screen" rel="stylesheet">

 <link rel="icon" href="assets/images/favicon.ico">
    
</head>

<body>

  <header id="header-wrap" class="hidden-xs">
    <div class="container">
        <div id="header" class="row">
            <div class="col-md-8 col-sm-8 hidden-xs">
                <div class="" style="float: left">
                        <a href="" title="Home" rel="home" id="ncar-ucar-logo">
                            <img src="assets/images/ncar_ucar_header_logo.png" alt="Home">
                        </a>
                </div>
             <!--   Use this div instead of above to show custom text in header (e.g. app name) vs "National Center for Atmospheric Research" part of logo 
                    from ncar_ucar_header_logo.png -->
             <!--  <div class="hidden-sm" id="app-title-column">
                        <a href="" title="Home" rel="home">
                            <span id="app-title">NCAR Datacite Assets</span>                             
                        </a>
                </div> -->
            </div>
            <div class="col-md-4 col-sm-4 hidden-xs">
                <a href="http://www.nsf.gov/">
                    <img src="assets/images/nsf_header.png" class="img-responsive" id="nsf-header">
                </a>
            </div>
        </div>
    </div>
</header>

<main class="container">

  <div id="titleblock" > 
    <h1>NCAR DataCite Data Assets</h1>
    <h3>Prototype Version</h3>
  </div>

<div class="panel panel-warning">
    <div class="panel-heading">
      <h3 class="panel-title">Note: This is a prototype version and provides access to a limited subset of data.</h3>
    </div>
    <div class="panel-body">
       <h5 class="media-heading">Please <a href="mailto:dset-support@ucar.edu?Subject=DSET%20Datacite%20Search%20Page" target="_top">email SAGE support</a> to provide feedback</a>.</h5>
    </div>
  </div>

  <h1>DataCite Search</h1>

<!-- no action, self submit -->
  <form name="simpleQueryForm" id="simpleQueryForm" class="form-inline"  method="GET">
        <div class="form-group">
            <label class="sr-only" for="freetext">Search</label>

            <input type="text" name="freetext" id="freetext" size="32" class="form-control">

            <button class="btn btn-success" id="submitButton">Search</button> 

            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#searchHelp">Help</button>

            <!-- Bootstrap Modal for help text-->
            <div class="modal fade" id="searchHelp" role="dialog">
              <div class="modal-dialog">
              
                <!-- Modal content-->
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h3 class="modal-title">Search Help</h3>
                  </div>
                  <div class="modal-body">
                    <p>Use * to find all records, or enter a search term. Examples can be found at the <a href="http://search.datacite.org/help.html">DataCite</a> Metadata search page.
                    <h4>Query Examples</h4>
                    <table>
                      <tr>
                        <th>query</th>
                        <th>retrieves documents...</th>
                      </tr>
                      <tr>
                        <td><code>climate</code></td>
                        <td>containing <em>climate</em></td>
                      </tr>
                      <tr>
                        <td><code>climate change</code></td>
                        <td>containing <em>climate</em> and <em>change</em></td>
                      </tr>
                      <tr>
                        <td><code>climate -change</code></td>
                        <td>containing <em>climate</em> and not <em>change</em></td>
                      </tr>
                      <tr>
                        <td><code>climate AND (red OR green)</code></td>
                        <td>containing <em>climate</em> and <em>red</em> or <em>green</em></td>
                      </tr>
                      <tr>
                        <td><code>"solar flare"</code></td>
                        <td>containing <em>solar flare</em> as a phrase</td>
                      </tr>
                      <tr>
                        <td><code>description:glacier</code></td>
                        <td>containing <em>glacier</em> in metadata field <em>description</em></td>
                      </tr>
                      <tr>
                        <td><code>ResourceTypeGeneral:Software</code></td>
                        <td>containing <em>Software</em> in <em>Resource Type</em></td>
                      </tr>
                      <tr>
                        <td><code>allocator:(BL OR TIB)</code></td>
                        <td>belonging to DataCite members <a href="http://datacite.org/britishlibrary">BL</a> or <a href="http://datacite.org/TIB">TIB</a></td>
                      </tr>
                      <tr>
                        <td><code>publicationYear:[2000 TO 2005]</code></td>
                        <td>published between 2000 and 2005</td>
                      </tr>
                      <tr>
                        <td><code>uploaded:[NOW-5DAYS TO NOW]</code></td>
                        <td>uploaded to DataCite in the last 5 days</td>
                      </tr>
                    </table>
                    </p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                  </div>
                </div>
                
              </div>
            </div>
        </div>
  </form>

<br>

    <!-- Results populated by jQuery -->
    <div id="datablock">

      <div id="numFoundWell" class="well">
        <div id="numFound">
           <!--numFound text put here -->   
        </div>
      </div>
      
      <div id="displayResults">
          <!-- Query results put here -->
      </div> 
      
    </div> <!-- datablock -->    

</main>

<footer class="container" id="footer-wrap">
  
      <div id="orgFooter"><p>© 2016 UCAR | <a href="http://www2.ucar.edu/privacy-policy" target="_blank">Privacy Policy</a> | <a href="http://www2.ucar.edu/terms-of-use" target="_blank">Terms of Use</a> | <a href="https://www2.ucar.edu/notification-copyright-infringement-digital-millennium-copyright-act" target="_blank">Copyright Issues</a> | <a href="http://www.nsf.gov" target="_blank">Sponsored by NSF</a> | <a href="http://www.ucar.edu" target="_blank">Managed by UCAR</a> | <a href="https://ncar.ucar.edu/contact">Webmaster/Feedback</a> 
      <br>Postal Address: P.O. Box 3000, Boulder, CO 80307-3000 • Shipping Address: 3090 Center Green Drive, Boulder, CO 80301</p>
      <p>The National Center for Atmospheric Research is sponsored by the National Science Foundation. Any opinions, findings and conclusions or recommendations expressed in this publication are those of the author(s) and do not necessarily reflect the views of the National Science Foundation.</p></div>
</footer>


<script>

function queryDatacite(numberOfRows, searchtext) {

  //console.log ('in queryDatacite function numberOfRows=' + numberOfRows);

  //search_string = searchtext.searchtext;
  search_string = searchtext;

  //console.log ('in queryDatacite function search_string=' + search_string);
  //console.log ('in queryDatacite function search_string.len=' + search_string.length);

  // If no params (like on initial load) form is empty/ready.
  if (search_string == null || (!search_string.trim())) {

   return "";
  }
  else
  {  
    var querystring = "https://search.datacite.org/api?q=" + search_string + "&fq=prefix:10.5065&wt=json&indent=true&fl=doi,title,description,publicationYear,contributor,creator,resourceTypeGeneral,resourceTypeGeneral&rows="+numberOfRows;
  }

  console.log ('**in queryDatacite function querystring=' + querystring);

  data = $.ajax({
    url: querystring,
    type: "get",
    dataType: "json"
  });

  return data;
}

function updateDisplayNumberOfRecordsFound (numberOfRecordsFound) {

   $('#numFound').html('<strong>Number of records found: </strong>' + numberOfRecordsFound);
}

function updateDisplayResults (doclist) {

  // replace previous results
  $('#displayResults').html("");

  $.each(doclist, function (i) {

    var title = doclist[i].title;
    var doi = doclist[i].doi;
    var title_link = '<a href=http://dx.doi.org/' + doi + '>' + title + '</a>';  
    var doi_link = '<a href=http://dx.doi.org/' + doi + '>' + doi + '</a>';
    var description = doclist[i].description;
    var contributor = doclist[i].contributor;
    var creator = doclist[i].creator;   
    var resourceTypeGeneral = doclist[i].resourceTypeGeneral;      
     //console.log("doi field: " + doi);
    
    // This sets up the display of the page (template)
     // $('#display').append(doi_link + "<br><div>" + title + "</div><br><div>" + description + "</div><br>");
    $('#displayResults').append("<div><b>" + title_link+ "</b></div>");
    $('#displayResults').append("<div>" + doi + "</div>");
    $('#displayResults').append("<div><h5>Description</h5>" + description + "</div>");
    $('#displayResults').append("<div><h5>Contributors</h5>" + contributor + "</div>");
    $('#displayResults').append("<div><h5>Creator</h5>" + creator + "</div>");
    $('#displayResults').append("<div><h5>Resource Type</h5>" + resourceTypeGeneral + "</div>");
    $('#displayResults').append("<hr>");

  });           
}   

// Get the param passed in to the form in the URL
// TODO: Only need 1 of these functions.  Which one?
function getParameterByName(name) {
    var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
    return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
}

var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
};

/* On page load, get the parameter from the url (nothing or text) and use that to set up the query to DataCite.
** First get the number of records that match the criteria, and use that as the "rows" param to the DataCite API query to maximize efficiency
** of the 2nd query to DataCite, which gets the JSON results.  The results are displayed by modifying div placeholder contents.
*/
$(document).ready(function() {

  $("#numFoundWell").hide();

 

    // get the form data from the param passed
    var searchtext = getParameterByName('freetext');
    //console.log ("searchtext=" + searchtext );

    $("#freetext").val(searchtext);

    queryDatacite(0, searchtext)
    .done (function(data) {

      //console.log ("returned data: " + JSON.stringify(data));

      var numberOfRecordsFound = data.response.numFound;

      $("#numFoundWell").show();

      updateDisplayNumberOfRecordsFound(numberOfRecordsFound);       
      
      queryDatacite(numberOfRecordsFound, searchtext)
      .done (function (data) {
      
          var doclist = data.response.docs;
          //console.log(JSON.stringify(doclist));   
                
          updateDisplayResults (doclist);

      });
    });        
         
}); //ready
</script>

</body>
</html>
